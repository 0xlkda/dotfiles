source ~/code/dotfiles/tmux/tmux.reset.conf

# General
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on
set -g mouse on
set -g history-limit 50000
set -g status-position top
set -g default-shell /bin/zsh
set -g default-command "/bin/zsh -l"
set -sg escape-time 0
set -g focus-events on
set -s set-clipboard on
set -g monitor-activity on
set -g visual-activity off

# Terminal
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*:Tc"
set -as terminal-features ",*:sync"

# Theme
set -g status on
set -g status-left-length 42
set -g status-right-length 150
set -g window-status-separator " "
set -g window-status-activity-style none
set -g window-status-bell-style none

run-shell "~/code/dotfiles/tmux/theme.sh light"
bind T run-shell "~/code/dotfiles/tmux/theme.sh toggle"

# Keybindings
set -wg mode-keys vi

## Copy
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "~/code/dotfiles/tmux/osc52-copy.sh"
bind p run-shell "tmux set-buffer -- \"$(pbpaste)\" && tmux paste-buffer"

## Navigation
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "send-keys -R C-l"
bind j select-pane -t :.-
bind k select-pane -t :.+
bind ` switch-client -l
bind s choose-tree -w
bind h switch-client -t lkda
bind C-x if-shell -F '#{==:#{session_name},overview}' \
  "run-shell -b '#{@ms_root}/bin/dev-session-kill #{pane_tty}'" \
  "switch-client -t lkda \; run-shell -b '#{@ms_root}/bin/dev-session-kill #{session_name}'"

## Pane resize
bind -r H resize-pane -L 1
bind -r J resize-pane -D 1
bind -r K resize-pane -U 1
bind -r L resize-pane -R 1
bind C-m run-shell "~/code/dotfiles/tmux/tmux-smart-resize.sh"

## Windows
bind -r < run 'tmux swap-window -d -t #{e|-|:#I,1}'
bind -r > run 'tmux swap-window -d -t #{e|+|:#I,1}'
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}" \; command-prompt -p "Name for this new window: " "rename-window '%%'"
set -g @ms_root "~/code/lkda/my-scripts"
bind C-c run-shell '#{@ms_root}/bin/dev-session'
bind C-o run-shell '#{@ms_root}/bin/dev-session-overview' \; switch-client -t overview
bind -n C-q if-shell -F '#{==:#{session_name},overview}' 'switch-client -l'

## Utilities
bind C-a set-window-option synchronize-panes
bind R source-file ~/.config/tmux/tmux.conf \; display "Config Reloaded!"
bind Z run-shell '\
  self="#{pane_id}"; \
  for p in $(tmux list-panes -a -F "##{pane_id}:##{pane_current_command}"); do \
    id="${p%%:*}"; cmd="${p##*:}"; \
    [ "$id" = "$self" ] && continue; \
    [ "$cmd" != "zsh" ] && continue; \
    tmux send-keys -t "$id" "reload" Enter; \
  done; \
  tmux display "Reloaded zsh"'

# Device detection (updates scroll direction on session attach)
set -g @active-device ""
set-hook -g client-attached 'run-shell "~/code/dotfiles/tmux/scroll-direction.sh detect #{client_pid}"'
bind S run-shell "~/code/dotfiles/tmux/scroll-direction.sh toggle"
run-shell "~/code/dotfiles/tmux/scroll-direction.sh detect #{client_pid}"

# Plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
run '~/.tmux/plugins/tpm/tpm'
